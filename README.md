![Deployment](https://github.com/cybersokari/allure-docker-deploy/actions/workflows/deploy.yaml/badge.svg?branch=main)

# Allure Docker Deploy
***The `allure deploy` command we all needed.***

This [Docker image](https://hub.docker.com/r/sokari/allure-docker-deploy) is for testers who need to share their [Allure test reports](https://allurereport.org/) with stakeholders and save results in cloud. 
With minimal setup, this image enables test results to be uploaded to a cloud storage bucket, generate a hosted Allure report, and share it via an autogenerated
[Firebase-hosted website](https://firebase.google.com/docs/hosting). Empowers you to create multiple Allure report test run pages, a feature not possible with standard Allure Reports.

---

## Key Features
- **Cloud Storage**: Auto save Allure test results and history in a Google Cloud Storage bucket.
- **Test Report preview URL**: Generates and hosts Allure reports on a website for easy sharing with stakeholders, powered by Firebase Hosting
- **Slack notification** Review Test report preview URL in Slack after every test run (Coming soon)
- **Watch Mode**: Continuously detects test results and takes action (backup to storage and/or publish report website). This keeps the container running and can be enabled for non-CI environments.
---

## Use cases
### GitHub Actions
```yaml
name: Example CI Pipeline with Allure Docker Deploy
on:
  push:
    branches:
      - main
jobs:
  test-and-report:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Run Tests
      run: |
        # Run your tests and output results to a directory
        mkdir -p ./allure-results
        ./gradlew test --output-dir ./allure-results
           - name: Authenticate Docker Hub
    - uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Deploy Allure Report to Firebase
      uses: docker://sokari/allure-docker-deploy
      with:
         args:  |
            -e GOOGLE_APPLICATION_CREDENTIALS=/credentials/gcp-key.json \
            -e STORAGE_BUCKET=my-test-results-bucket \
            -e WEBSITE_ID=my-custom-site-id \
            -e WEBSITE_EXPIRES=3d \
            -e KEEP_RETRIES=true \
            -v ${{ github.workspace }}/allure-results:/allure-results \
            -v ${{ secrets.GCP_CREDENTIALS_FILE_PATH }}:/credentials/gcp-key.json \
```

### Local test runs
#### Step 1: Pull the Docker Image
```bash
docker pull sokari/allure-docker-deploy:latest
```
#### Step 2: Run the Container
```shell
docker run -d \
  -e GOOGLE_APPLICATION_CREDENTIALS=/credentials/gcp-key.json \
  -e STORAGE_BUCKET=my-test-results-bucket \
  -e WEBSITE_ID=my-custom-site-id \
  -e WEBSITE_EXPIRES=2d \
  -e WATCH_MODE=true \
  -e TTL_SECS=60 \
  -v /path/to/allure-results:/allure-results \
  -v /path/to/gcp-key.json:/credentials/gcp-key.json \
  sokari/allure-docker-deploy
```
With `docker-compose.yaml`:
```yaml
services:  
  allure:
    image: sokari/allure-docker-deploy
    container_name: deploy-service
    volumes:
      - /path/to/allure-results:/allure-results
      - /path/to/service-account.json:/service-account.json
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: /service-account.json
      STORAGE_BUCKET: your-storage-bucket
      KEEP_HISTORY: true # Default is true when STORAGE_BUCKET is provided
      KEEP_RETRIES: false # Default is false
      # Uncomment the line below to enable Hosting
      # WEBSITE_ID: your-firebase-site-id
      # WEBSITE_EXPIRES: 2d
      WATCH_MODE: true
      TTL_SECS: 60
```


## Requirements
1. **Google Cloud Credentials**:
    - Set up a Google Cloud [service account](https://firebase.google.com/docs/admin/setup#initialize_the_sdk_in_non-google_environments) with access to your storage bucket and Firebase Hosting.
    - Download the `service-account-file.json` JSON file that the `GOOGLE_APPLICATION_CREDENTIALS` environment variable will point to.

2. **Google Cloud Storage Bucket**:
    - A storage bucket to store test results and reports.

3. **Website ID**:
    - A unique identifier for your hosted report website in Firebase (for example, `feature_mission-2-jupiter`).

---

## Environment Variables

| Variable                         | Description                                                                                                                         | Default |
|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|---------|
| `GOOGLE_APPLICATION_CREDENTIALS` | Path to the GCP service account JSON file (required).                                                                               | None    |
| `STORAGE_BUCKET`                 | Google Cloud Storage bucket name (required if using cloud storage).                                                                 | None    |
| `WEBSITE_ID`                     | A unique identifier of your choice to identify the Test Report website.                                                             | None    |
| `WEBSITE_EXPIRES`                | Duration before the generated website is disabled. Can be between 1d to 30d                                                         | 7d      |
| `KEEP_HISTORY`                   | Enable Allure Report history feature                                                                                                | true    |
| `KEEP_RETRIES`                   | Enable Allure Report retries feature                                                                                                | false   |
| `WATCH_MODE`                     | Keep the container running to auto deploy new test reports and results (Ignored in when env is CI)                                  | false   |
| `TTL_SECS`                       | Time to wait (in seconds) after last file is detected before generating and uploading the report. Only works when `WATCH_MODE=true` | 45      |

**Note**: Either `STORAGE_BUCKET` or `WEBSITE_ID` must be provided. Both can be configured if you want to enable all functionalities.

---


## How it works 

1. Mount your test results directory (`/allure-results`) to the container.
2. Configure required environment variables:
   - `GOOGLE_APPLICATION_CREDENTIALS`: Path to your GCP credentials file.
   - `STORAGE_BUCKET`: The name of your Google Cloud Storage bucket (if using cloud storage).
   - `WEBSITE_ID`: A unique identifier for the Firebase Hosting site. You can use a different identifiers to get new website for every test run. Using the same `WEBSITE_ID` for multiple runs will replace the previous Test Report on the previously generated URL
3. When `WATCH_MODE` is set to `true`, the container will watch for updates in the `/allure-results` directory. Once no new files are detected within the `TTL_SECS` timeframe, it will:
   - Upload results to the specified Google Cloud Storage bucket (if `STORAGE_BUCKET` is provided).
   - Host the generated Allure report on Firebase Hosting (if `WEBSITE_ID` is provided).
   - Perform both actions if both environment variables are set.
4. Optionally configure `TTL_SECS` (default: 45 seconds) when running in `WATCH_MODE` to delay the active functionalities (Hosting/Storage) as Allure result files are being added to the `/allure-results`. On every new file detected, the `TTL_SECS` restarts the countdown towards deployment/storage. If no new file is detected after the `TTL_SECS`, deployment/storage action will begin.
5. [Report history and retries](https://allurereport.org/docs/history-and-retries/#history-and-retries) are auto enabled as `allure-report/history` directory is saved in storage after report generation.
6. The autogenerated Allure Report website is powered by Firebase hosting [preview channel](https://firebase.google.com/docs/hosting/test-preview-deploy?hl=en&authuser=0#preview-channels) which is ephemeral with a 7 days expiry by default. It can be adjusted with a `WEBSITE_EXPIRES` env variable in the docker run command or docker-compose file. Use `h` for hours, `d` for days, and `w` for weeks (for example, `12h`, `7d`, `2w`, respectively). Max duration is 30 days.


---

## View the hosted Allure Report
### URL in logs
After the report is generated, the URL to your hosted report will be output in the logs as `hosting:channel: Channel URL`. Share it with your team!

<div style="text-align: left"><img src="assets/firebase-hosting-cli.png" height="220" alt="Firebase CLI console output"></div>

### URL in Firebase Console
You can also find the website URL in your Firebase Console Dashboard.

#### URL to Slack (Coming soon)

License

This project is licensed under the [MIT License](https://opensource.org/licenses/MIT). See the LICENSE file for details.

Contributing

Contributions are welcome! Feel free to open issues or submit pull requests for bug fixes or new features.